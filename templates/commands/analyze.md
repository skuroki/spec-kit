---
description: タスク生成後の spec.md, plan.md, tasks.md 間で、非破壊的な成果物間の整合性と品質の分析を実行します。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --require-tasks --include-tasks
  ps: scripts/powershell/check-prerequisites.ps1 -Json -RequireTasks -IncludeTasks
---

## ユーザー入力

```text
$ARGUMENTS
```

先に進む前にユーザー入力を**必ず**考慮してください（入力が空でない場合）。

## ゴール

実装前に、3つの主要成果物 (`spec.md`, `plan.md`, `tasks.md`) 間で、不整合、重複、曖昧、過少指定の項目を特定します。このコマンドは、`/speckit.tasks` が完全な `tasks.md` を正常に生成した後に**のみ**実行しなければなりません(MUST)。

## 動作制約

**厳密に読み取り専用**: いかなるファイルも**修正しない**でください。構造化された分析レポートを出力します。オプションの修正計画を提示します (後続の編集コマンドを手動で呼び出す前に、ユーザーが明示的に承認する必要があります)。

**憲法の権限**: プロジェクト憲法 (`/memory/constitution.md`) は、この分析スコープ内では**交渉不可**です。憲法との矛盾は自動的に「CRITICAL (重要)」となり、原則の希薄化、再解釈、黙認ではなく、spec、plan、または tasks の調整が必要です。原則自体を変更する必要がある場合、それは `/speckit.analyze` 外の個別の明示的な憲法更新で行われなければなりません。

## 実行ステップ

### 1. 分析コンテキストの初期化

リポジトリルートから `{SCRIPT}` を一度実行し、JSONから FEATURE_DIR と AVAILABLE_DOCS をパースする。絶対パスを導出する:

- SPEC = FEATURE_DIR/spec.md
- PLAN = FEATURE_DIR/plan.md
- TASKS = FEATURE_DIR/tasks.md

必要なファイルが欠落している場合はエラーメッセージで中止する (欠落している前提コマンドを実行するようユーザーに指示する)。
引数内のシングルクォート（例: "I'm Groot"）については、エスケープ構文を使用すること: 例 'I'\''m Groot'（または可能ならダブルクォート: "I'm Groot"）。

### 2. 成果物の読み込み (段階的開示)

各成果物から必要最小限のコンテキストのみを読み込む:

**spec.md から:**

- 概要/コンテキスト
- 機能要件
- 非機能要件
- ユーザーストーリー
- エッジケース (存在する場合)

**plan.md から:**

- アーキテクチャ/スタック選択
- データモデル参照
- フェーズ
- 技術的制約

**tasks.md から:**

- タスクID
- 説明
- フェーズのグループ化
- 並行マーカー [P]
- 参照ファイルパス

**constitution (憲法) から:**

- `/memory/constitution.md` を読み込み、原則検証を行う

### 3. セマンティックモデルの構築

内部表現を作成する (出力に生の成果物を含めない):

- **要件インベントリ**: 安定したキーを持つ各機能/非機能要件 (命令句に基づいてスラグを導出; 例: "ユーザーはファイルをアップロードできる" → `user-can-upload-file`)
- **ユーザーストーリー/アクションインベントリ**: 受入基準を伴う個別のユーザーアクション
- **タスクカバレッジマッピング**: 各タスクを1つ以上の要件またはストーリーにマッピング (キーワード/明示的な参照パターン(IDやキーフレーズ)による推論)
- **憲法ルールセット**: 原則名と MUST/SHOULD の規範的ステートメントを抽出

### 4. 検出パス (トークン効率的な分析)

高シグナルの発見に集中する。合計50件に制限し、残りはオーバーフローサマリーに集約する。

#### A. 重複検出

- ほぼ重複した要件を特定
- 統合のために品質の低い言い回しをマーク

#### B. 曖昧さ検出

- 測定可能な基準を欠く曖昧な形容詞 (fast, scalable, secure, intuitive, robust) にフラグを立てる
- 未解決のプレースホルダー (TODO, TKTK, ???, `<placeholder>` など) にフラグを立てる

#### C. 過少指定 (Underspecification)

- 動詞はあるが目的語や測定可能な結果が欠落している要件
- 受入基準との整合性を欠くユーザーストーリー
- spec/plan で定義されていないファイルやコンポーネントを参照するタスク

#### D. 憲法との整合 (Constitution Alignment)

- MUST原則と矛盾する要件または計画要素
- 憲法で必須とされたセクションや品質ゲートの欠落

#### E. カバレッジギャップ

- 関連するタスクがゼロの要件
- 要件/ストーリーにマッピングされていないタスク
- タスクに反映されていない非機能要件 (例: パフォーマンス, セキュリティ)

#### F. 不整合 (Inconsistency)

- 用語の揺らぎ (ファイル間で異なる名前で呼ばれる同一概念)
- planで参照されているがspecにないデータエンティティ (またはその逆)
- タスク順序の矛盾 (例: 依存関係の注記なしに基盤セットアップタスクの前に統合タスクがある)
- 競合する要件 (例: 一方はNext.jsを要求し、他方はVueを指定)

### 5. 重大度割り当て

発見事項の優先順位付けにこのヒューリスティックを使用する:

- **CRITICAL (重要)**: 憲法のMUSTに違反、主要な仕様成果物の欠落、またはベースライン機能をブロックするカバレッジゼロの要件
- **HIGH (高)**: 重複または競合する要件、曖昧なセキュリティ/パフォーマンス属性、テスト不可能な受入基準
- **MEDIUM (中)**: 用語の揺らぎ、非機能タスクのカバレッジ欠落、過少指定のエッジケース
- **LOW (低)**: スタイル/文言の改善、実行順序に影響しない軽微な冗長性

### 6. コンパクトな分析レポートの作成

以下の構造を持つMarkdownレポートを出力する (ファイル書き込みなし):

## 仕様分析レポート (Specification Analysis Report)

| ID | カテゴリ (Category) | 重大度 (Severity) | 場所 (Location) | 概要 (Summary) | 推奨事項 (Recommendation) |
|----|-------------------|-------------------|-----------------|----------------|---------------------------|
| A1 | Duplication | HIGH | spec.md:L120-134 | 2つの類似した要件 ... | 言い回しをマージ; より明確なバージョンを維持 |

(発見事項ごとに1行追加; カテゴリのイニシャルをプレフィックスとした安定IDを生成)

**カバレッジサマリーテーブル (Coverage Summary Table):**

| 要件キー (Requirement Key) | タスクあり? (Has Task?) | タスクID (Task IDs) | 備考 (Notes) |
|-------------------------|------------------------|---------------------|--------------|

**憲法整合性の問題 (Constitution Alignment Issues):** (存在する場合)

**マッピングされていないタスク (Unmapped Tasks):** (存在する場合)

**指標:**

- 総要件数
- 総タスク数
- カバレッジ率 (1つ以上のタスクを持つ要件)
- 曖昧さカウント
- 重複カウント
- クリティカル問題カウント

### 7. 次のアクションの提示

レポートの最後に、簡潔な 「次のアクション (Next Actions)」 ブロックを出力する:

- CRITICALな問題が存在する場合: `/speckit.implement` の前に解決を推奨
- LOW/MEDIUMのみの場合: ユーザーは進めてもよいが、改善提案を提供する
- 明示的なコマンド提案を提供する: 例: "`/speckit.specify` を実行して洗練させる", "`/speckit.plan` を実行してアーキテクチャを調整する", "`tasks.md` を手動編集して 'パフォーマンス指標' のカバレッジを追加する"

### 8. 修正案の提示 (Remediation)

ユーザーに尋ねる: "上位N件の問題について具体的な修正案を提示しましょうか？" (自動的に適用**しない**こと。)

## 運用原則

### コンテキスト効率

- **最小限の高シグナルトークン**: 網羅的な文書化ではなく、行動可能な発見に焦点を当てる
- **段階的開示**: 成果物を増分的にロードする; すべてのコンテンツを分析にダンプしない
- **トークン効率的な出力**: 発見テーブルを50行に制限; オーバーフローは要約する
- **決定論的結果**: 変更なしで再実行した場合、一貫したIDとカウントを生成する

### 分析ガイドライン

- **ファイルを修正しない** (これは読み取り専用分析)
- **欠落セクションを幻覚で見ない** (存在しない場合は正確に報告する)
- **憲法違反を優先する** (これらは常にCRITICAL)
- **網羅的なルールよりも例を使用する** (一般的なパターンではなく、具体的な事例を引用する)
- **問題ゼロを優雅に報告する** (カバレッジ統計を含む成功レポートを出力する)

## コンテキスト

{ARGS}
