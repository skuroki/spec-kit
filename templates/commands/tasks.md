---
description: 利用可能な設計成果物に基づいて、機能のための実行可能で依存関係順に並べられた tasks.md を生成します。
handoffs: 
  - label: 整合性分析 (Analyze For Consistency)
    agent: speckit.analyze
    prompt: プロジェクトの整合性分析を実行してください
    send: true
  - label: プロジェクト実装 (Implement Project)
    agent: speckit.implement
    prompt: フェーズごとの実装を開始してください
    send: true
scripts:
  sh: scripts/bash/check-prerequisites.sh --json
  ps: scripts/powershell/check-prerequisites.ps1 -Json
---

## ユーザー入力

```text
$ARGUMENTS
```

先に進む前にユーザー入力を**必ず**考慮してください（入力が空でない場合）。

## 概要

1. **セットアップ**: リポジトリルートから `{SCRIPT}` を実行し、FEATURE_DIR と AVAILABLE_DOCS リストをパースする。すべてのパスは絶対パスであること。引数内のシングルクォート（例: "I'm Groot"）については、エスケープ構文を使用すること: 例 'I'\''m Groot'（または可能ならダブルクォート: "I'm Groot"）。

2. **設計ドキュメントの読み込み**: FEATURE_DIR から読み込む:
   - **必須**: plan.md (技術スタック, ライブラリ, 構造), spec.md (優先順位付きユーザーストーリー)
   - **オプション**: data-model.md (エンティティ), contracts/ (APIエンドポイント), research.md (決定事項), quickstart.md (テストシナリオ)
   - 注記: すべてのプロジェクトがすべてのドキュメントを持っているわけではありません。利用可能なものに基づいてタスクを生成します。

3. **タスク生成ワークフローの実行**:
   - plan.md を読み込み、技術スタック、ライブラリ、プロジェクト構造を抽出する
   - spec.md を読み込み、優先順位 (P1, P2, P3...) 付きのユーザーストーリーを抽出する
   - data-model.md が存在する場合: エンティティを抽出し、ユーザーストーリーにマッピングする
   - contracts/ が存在する場合: エンドポイントをユーザーストーリーにマッピングする
   - research.md が存在する場合: セットアップタスクの決定事項を抽出する
   - ユーザーストーリーごとにタスクを整理して生成する (下記「タスク生成ルール」参照)
   - ユーザーストーリーの完了順序を示す依存関係グラフを生成する
   - ユーザーストーリーごとに並列実行の例を作成する
   - タスクの完全性を検証する (各ユーザーストーリーが必要なすべてのタスクを持ち、独立してテスト可能であること)

4. **tasks.md の生成**: `templates/tasks-template.md` を構造として使用し、以下を埋める:
   - plan.md からの正しい機能名
   - フェーズ 1: セットアップタスク (プロジェクト初期化)
   - フェーズ 2: 基盤タスク (すべてのユーザーストーリーに対するブロッキング前提条件)
   - フェーズ 3+: ユーザーストーリーごとのフェーズ (spec.md の優先順位順)
   - 各フェーズの内容: ストーリーゴール、独立したテスト基準、テスト (要求された場合)、実装タスク
   - 最終フェーズ: 仕上げと横断的関心事
   - すべてのタスクは厳格なチェックリスト形式に従わなければならない (下記「タスク生成ルール」参照)
   - 各タスクの明確なファイルパス
   - ストーリー完了順序を示す依存関係セクション
   - ストーリーごとの並列実行例
   - 実装戦略セクション (MVPファースト、増分デリバリー)

5. **レポート**: 生成された tasks.md へのパスと以下を要約出力:
   - 総タスク数
   - ユーザーストーリーごとのタスク数
   - 特定された並列機会
   - 各ストーリーの独立したテスト基準
   - 提案されるMVPスコープ (通常はユーザーストーリー1のみ)
   - フォーマット検証: すべてのタスクがチェックリスト形式（チェックボックス、ID、ラベル、ファイルパス）に従っていることを確認

タスク生成のためのコンテキスト: {ARGS}

tasks.md は即座に実行可能であるべきです - 各タスクはLLMが追加のコンテキストなしで完了できるほど具体的でなければなりません。

## タスク生成ルール

**重要**: 独立した実装とテストを可能にするため、タスクはユーザーストーリーごとに整理されなければなりません(MUST)。

**テストはオプション**: 機能仕様書で明示的に要求された場合、またはユーザーがTDDアプローチを要求した場合のみ、テストタスクを生成してください。

### チェックリスト形式 (必須)

すべてのタスクは厳密にこの形式に従わなければなりません:

```text
- [ ] [TaskID] [P?] [Story?] ファイルパス付きの説明
```

**フォーマット構成要素**:

1. **チェックボックス**: 常に `- [ ]` (markdownチェックボックス) で開始する
2. **タスクID**: 実行順の連番 (T001, T002, T003...)
3. **[P] マーカー**: タスクが並列可能 (異なるファイル、未完了タスクへの依存なし) な場合のみ含める
4. **[Story] ラベル**: ユーザーストーリーフェーズのタスクにのみ必須
   - 形式: [US1], [US2], [US3] など (spec.md のユーザーストーリーにマップ)
   - セットアップフェーズ: ストーリーラベルなし
   - 基盤フェーズ: ストーリーラベルなし
   - ユーザーストーリーフェーズ: ストーリーラベル必須(MUST)
   - 仕上げフェーズ: ストーリーラベルなし
5. **説明**: 正確なファイルパスを含む明確なアクション

**例**:

- ✅ 正解: `- [ ] T001 実装計画に従ってプロジェクト構造を作成 scripts/setup.sh`
- ✅ 正解: `- [ ] T005 [P] 認証ミドルウェアを実装 src/middleware/auth.py`
- ✅ 正解: `- [ ] T012 [P] [US1] Userモデルを作成 src/models/user.py`
- ✅ 正解: `- [ ] T014 [US1] UserServiceを実装 src/services/user_service.py`
- ❌ 間違い: `- [ ] Userモデルを作成` (IDとストーリーラベル欠落)
- ❌ 間違い: `T001 [US1] モデルを作成` (チェックボックス欠落)
- ❌ 間違い: `- [ ] [US1] Userモデルを作成` (タスクID欠落)
- ❌ 間違い: `- [ ] T001 [US1] モデルを作成` (ファイルパス欠落)

### タスク構成

1. **ユーザーストーリーから (spec.md)** - 主要な構成:
   - 各ユーザーストーリー (P1, P2, P3...) は独自のフェーズを持つ
   - 関連するすべてのコンポーネントをそのストーリーにマッピング:
     - そのストーリーに必要なモデル
     - そのストーリーに必要なサービス
     - そのストーリーに必要なエンドポイント/UI
     - テストが要求された場合: そのストーリーに固有のテスト
   - ストーリーの依存関係をマークする (ほとんどのストーリーは独立しているべき)

2. **コントラクトから**:
   - 各コントラクト/エンドポイント → それが提供するユーザーストーリーへマッピング
   - テストが要求された場合: 各コントラクト → そのストーリーフェーズの実装前のコントラクトテストタスク [P]

3. **データモデルから**:
   - 各エンティティをそれを必要とするユーザーストーリーへマッピング
   - エンティティが複数のストーリーに提供する場合: 最も早いストーリーまたはセットアップフェーズに配置
   - 関係 → 適切なストーリーフェーズのサービスレイヤータスクへ

4. **セットアップ/インフラから**:
   - 共有インフラ → セットアップフェーズ (Phase 1)
   - 基盤/ブロッキングタスク → 基盤フェーズ (Phase 2)
   - ストーリー固有のセットアップ → そのストーリーのフェーズ内へ

### フェーズ構造

- **Phase 1**: セットアップ (プロジェクト初期化)
- **Phase 2**: 基盤 (ブロッキング前提条件 - ユーザーストーリーの前に完了しなければならない)
- **Phase 3+**: 優先順位順のユーザーストーリー (P1, P2, P3...)
  - 各ストーリー内: テスト (要求された場合) → モデル → サービス → エンドポイント → 統合
  - 各フェーズは、完全で、独立してテスト可能な増分であるべき
- **Final Phase**: 仕上げと横断的関心事

